<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Word Search Generator | 印刷・解答対応／逆向き・斜め禁止オプション</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root { --accent:#0066cc; --muted:#777; --bg:#f7f7fa; --hi:#b3e5fc; --hiBorder:#4fc3f7; }
  html,body{height:100%}
  body{
    margin:0;
    font-family:"Poppins","Noto Sans JP",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:var(--bg); color:#111; line-height:1.6;
  }
  .wrap{ max-width:1100px; margin:24px auto; padding:0 16px 48px; }
  h1{font-size:1.4rem;margin:0 0 12px}
  .grid{ display:grid; grid-template-columns:360px 1fr; gap:16px; }
  .panel{ background:#fff; border:1px solid #ddd; border-radius:10px; padding:14px 16px; box-shadow:0 2px 6px rgba(0,0,0,.04); }
  .panel h2{font-size:1.05rem;margin:0 0 8px}
  label{font-weight:600;font-size:.95rem}
  textarea,input,button{ font-family:inherit; font-size:1rem; }
  textarea{ width:100%; min-height:180px; resize:vertical; padding:10px; border:1px solid #ccc; border-radius:8px; background:#fff; }
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:6px 0}
  .row input[type="number"]{width:100px}
  .row input[type="checkbox"]{transform:translateY(1px)}
  button{ border:0; border-radius:8px; padding:10px 14px; cursor:pointer; font-weight:600; background:var(--accent); color:#fff; }
  button.secondary{background:#e6e6ef;color:#222}
  .hint{color:var(--muted);font-size:.9rem}
  .wordlist{ margin:8px 0 0; padding-left:16px; max-height:280px; overflow:auto; border-top:1px dashed #ddd; }
  .wordlist li{margin:6px 0}
  .board{ display:inline-grid; gap:2px; user-select:none; background:#ddd; border:1px solid #bbb; padding:6px; border-radius:8px; }
  .cell{ width:32px; height:32px; display:flex; align-items:center; justify-content:center; background:#fff; border:1px solid #ccc; border-radius:4px; font-weight:600; }
  .legend{margin-top:8px;color:var(--muted);font-size:.9rem}
  .error{color:#b00020;font-weight:600}
  .ok{color:#0a7a20;font-weight:600}

  /* 印刷シート（ふだん非表示） */
  #printSheet, #answerSheet { display:none; }
  .sheet{
    display:grid;
    grid-template-rows:auto 1fr auto;
    gap:10px;
  }
  .sheetTop{ display:flex; justify-content:center; align-items:center; padding-top:4px; }
  .sheetBoard .board .cell{ width:28px; height:28px; }
  .sheetBottom{ padding:8px 0 0; }
  .sheetWords{
    display:grid;
    grid-template-columns:repeat(2, 1fr);
    gap:4px 16px;
    font-size:1rem;
    list-style:none; padding:0; margin:0;
  }
  .sheetWords li{border-bottom:1px dotted #ddd; padding:2px 0}

  /* 印刷時の切替 */
  @media print{
    @page{ size:A4; margin:14mm; }
    body{ background:#fff }
    .wrap{ display:none !important; }
    #printSheet, #answerSheet { display:none !important; }
    /* data-print 属性で表示するシートを切替 */
    body[data-print="problem"] #printSheet{ display:block !important; }
    body[data-print="answer"]  #answerSheet{ display:block !important; }

    #printTitle, #answerTitle{ font-size:14pt; font-weight:700; text-align:center; margin-bottom:6mm; }
    .sheetBoard .board .cell{ width:22pt; height:22pt; border-radius:2pt; }
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>Word Search Generator（印刷・解答対応／逆向き・斜め禁止オプション）</h1>
  <div class="grid">
    <div class="panel">
      <h2>Word List（1行に1語。日本語は任意）</h2>
      <div class="hint">
        区切りは「タブ」「カンマ」「=」、または「英語（日本語）」でもOK。例：<br>
        apple　りんご / study abroad, 留学する / community=共同体 / participate（参加する）
      </div>
      <textarea id="words" placeholder="apple	りんご
study abroad	留学する
community	共同体
participate	参加する"></textarea>

      <div class="row">
        <label for="size">グリッドサイズ</label>
        <input id="size" type="number" min="8" max="30" value="14">
        <label><input id="diagonal" type="checkbox" checked> 斜め配置を許可</label>
        <label><input id="noDiagonal" type="checkbox"> 斜めは禁止（横と縦のみ）</label>
        <label><input id="forwardOnly" type="checkbox" checked> 逆向きは禁止（右→左／下→上を使わない）</label>
      </div>
      <div class="row">
        <label><input id="fillLower" type="checkbox" checked> 空マスを小文字で埋める</label>
        <label><input id="printPlacedOnly" type="checkbox" checked> 印刷は配置済みの語のみ</label>
        <span class="hint">未配置語も印刷したい場合はオフ</span>
      </div>

      <div class="controls">
        <button id="generate">パズルを生成</button>
        <button id="showAnswers" class="secondary">答えを表示/非表示</button>
        <button id="printProblem" class="secondary">問題を印刷</button>
        <button id="printAnswer" class="secondary">解答を印刷</button>
      </div>

      <div id="status" class="hint" aria-live="polite"></div>
      <h2 style="margin-top:12px">掲載語リスト（画面表示：英語＋日本語）</h2>
      <ul id="list" class="wordlist"></ul>
    </div>

    <div class="panel">
      <h2>パズル（盤面は英字のみ）</h2>
      <div id="board"></div>
      <div class="legend">左・印刷の語リストには日本語も表示、盤面には入りません。</div>
    </div>
  </div>
</div>

<!-- 問題用（ハイライト無し） -->
<div id="printSheet">
  <div id="printTitle">Word Search</div>
  <div class="sheet">
    <div class="sheetTop">
      <div id="printBoard" class="sheetBoard"></div>
    </div>
    <div class="sheetBottom">
      <h3 style="margin:8px 0 6px; font-size:1.05rem;">Words</h3>
      <ul id="printWords" class="sheetWords"></ul>
    </div>
  </div>
</div>

<!-- 解答用（ハイライト有り） -->
<div id="answerSheet">
  <div id="answerTitle">Word Search – Answer Key</div>
  <div class="sheet">
    <div class="sheetTop">
      <div id="answerBoard" class="sheetBoard"></div>
    </div>
    <div class="sheetBottom">
      <h3 style="margin:8px 0 6px; font-size:1.05rem;">Words</h3>
      <ul id="answerWords" class="sheetWords"></ul>
    </div>
  </div>
</div>

<script>
/* —— 文字列処理 —— */
function sanitizeForGrid(enRaw){
  return enRaw.normalize('NFKC').replace(/[^A-Za-z]/g, "");
}
function splitEnJa(line){
  const byDelim = line.split(/\t|,|=/);
  if(byDelim.length >= 2){
    return { en: (byDelim[0]||"").trim(), ja: byDelim.slice(1).join(" ").trim() };
  }
  const m = line.match(/^(.*?)[（(]([^()（）]+)[）)]\s*$/);
  if(m){ return { en: m[1].trim(), ja: m[2].trim() }; }
  return { en: line.trim(), ja: "" };
}
function parseLines(text){
  return text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length>0).map(splitEnJa).filter(x => x.en.length>0);
}

/* —— 盤面ユーティリティ —— */
function randInt(n){ return Math.floor(Math.random()*n); }
const DIRS_ORTHO = [{r:0,c:1},{r:0,c:-1},{r:1,c:0},{r:-1,c:0}];
const DIRS_DIAG = [{r:1,c:1},{r:1,c:-1},{r:-1,c:1},{r:-1,c:-1}];
function emptyGrid(n){ return Array.from({length:n}, () => Array.from({length:n}, () => "")); }
function canPlace(grid, word, r, c, dr, dc){
  const n = grid.length;
  for(let i=0;i<word.length;i++){
    const rr = r + dr*i, cc = c + dc*i;
    if(rr<0||rr>=n||cc<0||cc>=n) return false;
    const cell = grid[rr][cc];
    if(cell!=="" && cell !== word[i]) return false;
  }
  return true;
}
function placeWord(grid, word, r, c, dr, dc, mark){
  for(let i=0;i<word.length;i++){
    const rr = r + dr*i, cc = c + dc*i;
    grid[rr][cc] = word[i];
    if(mark) mark[rr][cc] = true;
  }
}
function fillRandom(grid, lower=true){
  const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
  const n = grid.length;
  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      if(grid[r][c]===""){
        const src = lower ? letters.toLowerCase() : letters;
        grid[r][c] = src[randInt(26)];
      }
    }
  }
}

/* —— 盤面描画（画面用） —— */
function drawBoard(container, grid, solutionMask=null){
  const n = grid.length;
  container.innerHTML = "";
  const board = document.createElement("div");
  board.className = "board";
  board.style.gridTemplateColumns = `repeat(${n}, 32px)`;
  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = grid[r][c] || "";
      if(solutionMask && solutionMask[r][c]){
        cell.style.background = "var(--hi)";
        cell.style.borderColor = "var(--hiBorder)";
        cell.setAttribute("data-solution","1");
      }
      board.appendChild(cell);
    }
  }
  container.appendChild(board);
}

/* —— 盤面描画（印刷用：ハイライト有無を切替） —— */
function drawBoardForPrint(container, grid, mask=null){
  const n = grid.length;
  container.innerHTML = "";
  const board = document.createElement("div");
  board.className = "board";
  board.style.gridTemplateColumns = `repeat(${n}, 28px)`;
  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      const cell = document.createElement("div");
      cell.className = "cell";
      cell.textContent = grid[r][c] || "";
      if(mask && mask[r][c]){
        cell.style.background = "var(--hi)";
        cell.style.borderColor  = "var(--hiBorder)";
      }
      board.appendChild(cell);
    }
  }
  container.appendChild(board);
}

/* —— 方向セットを作る —— */
function getDirs(allowDiag, noDiag, forwardOnly){
  // ベースは水平・垂直
  let dirs = [...DIRS_ORTHO];

  // 斜め禁止がオフ かつ 斜め許可がオン のときだけ斜めを追加
  if(!noDiag && allowDiag){
    dirs = dirs.concat(DIRS_DIAG);
  }

  // 逆向き禁止なら、右・下（と↘のみ）に制限
  if(forwardOnly){
    dirs = dirs.filter(d => (d.r>=0 && d.c>=0) && !(d.r===0 && d.c===0));
  }

  return dirs;
}

/* —— 生成ロジック —— */
function generatePuzzle(entries, size, allowDiag, noDiag, forwardOnly){
  const wordsForGrid = entries.map(x => sanitizeForGrid(x.en)).filter(w => w.length>0);
  const grid = emptyGrid(size);
  const mask = Array.from({length:size},()=>Array(size).fill(false));

  const dirs = getDirs(allowDiag, noDiag, forwardOnly);

  const order = wordsForGrid.map((w,i)=>({w,i})).sort((a,b)=>b.w.length - a.w.length);
  const placed = [];

  for(const {w,i} of order){
    const attempts = size*size*8;
    let ok = false;
    for(let t=0;t<attempts;t++){
      const dir = dirs[randInt(dirs.length)];
      const r0 = randInt(size), c0 = randInt(size);
      if(canPlace(grid, w, r0, c0, dir.r, dir.c)){
        placeWord(grid, w, r0, c0, dir.r, dir.c, mask);
        placed.push(i);
        ok = true; break;
      }
    }
  }
  return { grid, mask, placedIndices: placed };
}

/* —— DOM —— */
const $ = (sel)=>document.querySelector(sel);
const wordsTA = $("#words");
const listUL = $("#list");
const boardDiv = $("#board");
const statusDiv = $("#status");
const sizeInput = $("#size");
const diagChk = $("#diagonal");
const noDiagChk = $("#noDiagonal");
const forwardChk = $("#forwardOnly");
const fillLowerChk = $("#fillLower");
const printPlacedOnlyChk = $("#printPlacedOnly");
const btnGen = $("#generate");
const btnAns = $("#showAnswers");
const btnPrintProblem = $("#printProblem");
const btnPrintAnswer  = $("#printAnswer");

const printBoardDiv  = $("#printBoard");
const printWordsUL   = $("#printWords");
const answerBoardDiv = $("#answerBoard");
const answerWordsUL  = $("#answerWords");

let last = { grid:null, mask:null, entries:[], show:false, placedIndices:[] };

function refreshList(entries, placedIndices){
  listUL.innerHTML = "";
  entries.forEach((it, idx)=>{
    const inBoard = placedIndices.includes(idx);
    const li = document.createElement("li");
    li.innerHTML = `<strong>${it.en}</strong>${it.ja ? `（${it.ja}）` : ""}` + (inBoard? "" : ` <span style="color:#b00020">※未配置</span>`);
    listUL.appendChild(li);
  });
}
function updateStatus(total, placed){
  if(placed===total){
    statusDiv.innerHTML = `<span class="ok">全ての語を配置しました。</span>`;
  }else{
    const miss = total-placed;
    statusDiv.innerHTML = `<span class="error">${miss} 個の語は配置できませんでした。グリッドを大きくするか、長い語を減らしてください。</span>`;
  }
}

/* —— 印刷用の構築 —— */
function buildSheets(){
  if(!last.grid) return;
  const onlyPlaced = printPlacedOnlyChk.checked;
  const items = last.entries.map((x,idx)=>({en:x.en, ja:x.ja, idx}));
  const source = onlyPlaced ? items.filter(it=>last.placedIndices.includes(it.idx)) : items;

  // 問題用（ハイライトなし）
  drawBoardForPrint(printBoardDiv, last.grid, null);
  printWordsUL.innerHTML = "";
  source.forEach(it=>{
    const li = document.createElement("li");
    li.textContent = it.ja ? `${it.en}（${it.ja}）` : it.en;
    printWordsUL.appendChild(li);
  });

  // 解答用（ハイライトあり）
  drawBoardForPrint(answerBoardDiv, last.grid, last.mask);
  answerWordsUL.innerHTML = "";
  source.forEach(it=>{
    const li = document.createElement("li");
    li.textContent = it.ja ? `${it.en}（${it.ja}）` : it.en;
    answerWordsUL.appendChild(li);
  });
}

/* —— 印刷実行（Safari対策） —— */
function doPrint(mode){
  if(!last.grid){
    alert("先に「パズルを生成」を押してください。");
    return;
  }
  buildSheets();
  document.body.setAttribute("data-print", mode);
  requestAnimationFrame(()=>requestAnimationFrame(()=>{ window.print(); }));
}
window.addEventListener("afterprint", ()=>{ document.body.removeAttribute("data-print"); });

/* —— イベント —— */
btnGen.addEventListener("click", ()=>{
  const entries = parseLines(wordsTA.value);
  if(entries.length===0){
    statusDiv.textContent = "語がありません。Word List に入力してください。";
    return;
  }
  const n = Math.max(8, Math.min(30, parseInt(sizeInput.value||"14",10)));
  const { grid, mask, placedIndices } = generatePuzzle(
    entries, n,
    diagChk.checked,
    noDiagChk.checked,
    forwardChk.checked
  );
  fillRandom(grid, fillLowerChk.checked);
  last = { grid, mask, entries, show:false, placedIndices };

  drawBoard(boardDiv, grid, null);
  refreshList(entries, placedIndices);
  updateStatus(entries.length, placedIndices.length);
  buildSheets();
});
btnAns.addEventListener("click", ()=>{
  if(!last.grid) return;
  last.show = !last.show;
  drawBoard(boardDiv, last.grid, last.show ? last.mask : null);
});
btnPrintProblem.addEventListener("click", ()=>doPrint("problem"));
btnPrintAnswer .addEventListener("click", ()=>doPrint("answer"));
printPlacedOnlyChk.addEventListener("change", buildSheets);

/* —— 初期デモ —— */
document.addEventListener("DOMContentLoaded", ()=>{
  wordsTA.value = `apple\tりんご
study abroad\t留学する
community\t共同体
participate\t参加する
represent（表す）
estimate=見積もる`;
});
</script>
</body>
</html>
